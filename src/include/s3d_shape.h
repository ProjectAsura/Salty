//-----------------------------------------------------------------------------------
// File : s3d_shape.h
// Desc : Shape Module.
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------------

#ifndef __S3D_SHAPE_H__
#define __S3D_SHAPE_H__

//-----------------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------------
#include <s3d_typedef.h>
#include <s3d_math.h>
#include <s3d_box.h>
#include <s3d_texture.h>


namespace s3d {

//-----------------------------------------------------------------------------------
// Forward Declarations.
//-----------------------------------------------------------------------------------
struct IShape;


//-----------------------------------------------------------------------------------
// Constant Values
//-----------------------------------------------------------------------------------
const f64 REFRACTITY_WATER   = 1.33;  // 水の屈折率 (1.3)
const f64 REFRACTITY_CRYSTAL = 1.54;  // 水晶の屈折率 (1.54).
const f64 REFRACTITY_DIAMOND = 2.42;  // ダイアモンドの屈折率 (2.42)


/////////////////////////////////////////////////////////////////////////////////////
// MATERIAL_TYPE enum
/////////////////////////////////////////////////////////////////////////////////////
enum MATERIAL_TYPE
{
    MATERIAL_TYPE_MATTE,    // つやけし.
    MATERIAL_TYPE_MIRROR,   // 鏡.
    MATERIAL_TYPE_CRYSTAL,  // 水晶.
};


/////////////////////////////////////////////////////////////////////////////////////
// HitRecord structure
/////////////////////////////////////////////////////////////////////////////////////
struct HitRecord
{
    f64             distance;       //!< 衝突点までの距離.
    Vector3         position;       //!< 衝突点の位置座標.
    Vector3         normal;         //!< 法線ベクトル.
    Vector2         texcoord;       //!< 衝突点のテクスチャ座標です.
    const IShape*   pShape;         //!< オブジェクトへのポインタ.

    //-------------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------------
    HitRecord()
    : distance   ( D_MAX )
    , position   ( 0.0, 0.0, 0.0 )
    , normal     ( 0.0, 0.0, 0.0 )
    , texcoord   ( 0.0, 0.0 )
    , pShape     ( nullptr )
    { /* DO_NOTHING */ }
};


/////////////////////////////////////////////////////////////////////////////////////
// IMaterial interface
/////////////////////////////////////////////////////////////////////////////////////
struct IMaterial
{
    //-------------------------------------------------------------------------------
    //! @brief      マテリアルタイプを取得します.
    //-------------------------------------------------------------------------------
    virtual MATERIAL_TYPE GetType() const = 0;

    //-------------------------------------------------------------------------------
    //! @brief      自己発光カラーを取得します.
    //-------------------------------------------------------------------------------
    virtual Color GetEmissive() const = 0;

    //-------------------------------------------------------------------------------
    //! @brief      マテリアルカラーを取得します.
    //-------------------------------------------------------------------------------
    virtual Color GetColor() const = 0;

    //-------------------------------------------------------------------------------
    //! @brief      テクスチャカラーを取得します.
    //-------------------------------------------------------------------------------
    virtual Color GetTextureColor( const Vector2& ) const = 0;
};


/////////////////////////////////////////////////////////////////////////////////////
// IShape interface
/////////////////////////////////////////////////////////////////////////////////////
struct IShape
{
    //-------------------------------------------------------------------------------
    //! @brief      交差判定します.
    //-------------------------------------------------------------------------------
    virtual bool IsHit( const Ray&, HitRecord& record ) const = 0;

    //-------------------------------------------------------------------------------
    //! @brief      マテリアルを取得します.
    //-------------------------------------------------------------------------------
    virtual const IMaterial* GetMaterial() const = 0;

    //-------------------------------------------------------------------------------
    //! @brief      バウンディングボックスを取得します.
    //-------------------------------------------------------------------------------
    virtual BoundingBox GetBox() const = 0;
};


/////////////////////////////////////////////////////////////////////////////////////
// MaterialBase structure
/////////////////////////////////////////////////////////////////////////////////////
struct MaterialBase : public IMaterial
{
    Color           emissive;       //!< 自己発光カラーです.
    Color           color;          //!< マテリアルカラーです.
    MATERIAL_TYPE   type;           //!< マテリアルタイプです.
    Texture2D       texture;        //!< 2次元テクスチャです.
    TextureSampler  sampler;        //!< テクスチャサンプラーです.

    //---------------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //---------------------------------------------------------------------------------
    MaterialBase()
    : emissive  ( 0.0, 0.0, 0.0 )
    , color     ( 0.0, 0.0, 0.0 )
    , type      ( MATERIAL_TYPE_MATTE )
    , texture   ()
    , sampler   ()
    { /* DO_NOTHING */ }

    //---------------------------------------------------------------------------------
    //! @brief      引数付きコンストラクタです.
    //---------------------------------------------------------------------------------
    MaterialBase( const Color& _emissive, const Color& _color, const MATERIAL_TYPE _type )
    : emissive  ( _emissive )
    , color     ( _color )
    , type      ( _type )
    , texture   ()
    , sampler   ()
    { /* DO_NOTHING */ }

    //---------------------------------------------------------------------------------
    //! @brief      引数付きコンストラクタです.
    //---------------------------------------------------------------------------------
    MaterialBase( const Color& _emissive, const Color& _color, const MATERIAL_TYPE _type, const char* filename, const TextureSampler& _sampler = TextureSampler() )
    : emissive  ( _emissive )
    , color     ( _color )
    , type      ( _type )
    , texture   ( filename )
    , sampler   ( _sampler )
    { /* DO_NOTHING */ }

    //--------------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //--------------------------------------------------------------------------------
    virtual ~MaterialBase()
    {
        texture.Release();
    }

    //--------------------------------------------------------------------------------
    //! @brief      マテリアルタイプを取得します.
    //--------------------------------------------------------------------------------
    virtual MATERIAL_TYPE GetType() const
    { return type; }

    //--------------------------------------------------------------------------------
    //! @brief      自己発行カラーを取得します.
    //--------------------------------------------------------------------------------
    virtual Color GetEmissive() const
    { return emissive; }

    //--------------------------------------------------------------------------------
    //! @brief      マテリアルカラーを取得します.
    //--------------------------------------------------------------------------------
    virtual Color GetColor() const
    { return color; }

    //--------------------------------------------------------------------------------
    //! @brief      テクスチャカラーを取得します.
    //--------------------------------------------------------------------------------
    virtual Color GetTextureColor( const Vector2& texcoord ) const
    { return texture.Sample( sampler, texcoord );  }
};


//////////////////////////////////////////////////////////////////////////////////////
// Sphere structure
//////////////////////////////////////////////////////////////////////////////////////
struct Sphere : public IShape
{
    f64                 radius;         //!< 半径です.
    Vector3             position;       //!< 中心位置です.
    const IMaterial*    pMaterial;      //!< マテリアルです.

    //--------------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //--------------------------------------------------------------------------------
    Sphere
    (
        const f64,
        const Vector3&,
        const IMaterial*
    );

    //-------------------------------------------------------------------------------
    //! @brief      交差判定します.
    //-------------------------------------------------------------------------------
    bool IsHit(const Ray&, HitRecord& ) const;

    //-------------------------------------------------------------------------------
    //! @brief      マテリアルを取得します.
    //-------------------------------------------------------------------------------
    const IMaterial* GetMaterial() const;

    //-------------------------------------------------------------------------------
    //! @brief      バウンディングボックスを取得します.
    //-------------------------------------------------------------------------------
    BoundingBox GetBox() const;
};


/////////////////////////////////////////////////////////////////////////////////////
// Triangle structure
/////////////////////////////////////////////////////////////////////////////////////
struct Triangle : public IShape
{
    Vector3         p0;         //!< 頂点座標0
    Vector3         p1;         //!< 頂点座標1
    Vector3         p2;         //!< 頂点座標2
    Vector3         normal;     //!< 法線ベクトル.
    Vector2         uv0;        //!< テクスチャ座標0
    Vector2         uv1;        //!< テクスチャ座標1
    Vector2         uv2;        //!< テクスチャ座標2
    const IMaterial*      pMaterial;  //!< マテリアルを取得します.

    //------------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //------------------------------------------------------------------------------
    Triangle
    (
        const Vector3&,
        const Vector3&,
        const Vector3&,
        const IMaterial*,
        const Vector2& = Vector2( 0.0, 0.0 ),
        const Vector2& = Vector2( 0.0, 0.0 ),
        const Vector2& = Vector2( 0.0, 0.0 )
    );

    //------------------------------------------------------------------------------
    //! @brief      交差判定を行います.
    //------------------------------------------------------------------------------
    bool IsHit ( const Ray&, HitRecord& ) const;

    //-------------------------------------------------------------------------------
    //! @brief      マテリアルを取得します.
    //-------------------------------------------------------------------------------
    const IMaterial* GetMaterial() const;

    //-------------------------------------------------------------------------------
    //! @brief      バウンディングボックスを取得します.
    //-------------------------------------------------------------------------------
    BoundingBox GetBox() const;
};


////////////////////////////////////////////////////////////////////////////////////
// Quad structure
////////////////////////////////////////////////////////////////////////////////////
struct Quad : public IShape
{
    Vector3         p0;         //!< 頂点座標0です.
    Vector3         p1;         //!< 頂点座標1です.
    Vector3         p2;         //!< 頂点座標2です.
    Vector3         p3;         //!< 頂点座標3です.
    Vector3         normal;     //!< 法線ベクトルです.
    Vector2         uv0;        //!< テクスチャ座標0です.
    Vector2         uv1;        //!< テクスチャ座標1です.
    Vector2         uv2;        //!< テクスチャ座標2です.
    Vector2         uv3;        //!< テクスチャ座標3です.
    const IMaterial*      pMaterial;  //!< マテリアルです.

    //------------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //------------------------------------------------------------------------------
    Quad
    (
        const Vector3&,
        const Vector3&,
        const Vector3&,
        const Vector3&,
        const IMaterial*,
        const Vector2& = Vector2( 0.0, 0.0 ),
        const Vector2& = Vector2( 0.0, 0.0 ),
        const Vector2& = Vector2( 0.0, 0.0 ),
        const Vector2& = Vector2( 0.0, 0.0 )
    );

    //------------------------------------------------------------------------------
    //! @brief      交差判定を行います.
    //------------------------------------------------------------------------------
    bool IsHit ( const Ray&, HitRecord& ) const;

    //-------------------------------------------------------------------------------
    //! @brief      マテリアルを取得します.
    //-------------------------------------------------------------------------------
    const IMaterial* GetMaterial() const;

    //-------------------------------------------------------------------------------
    //! @brief      バウンディングボックスを取得します.
    //-------------------------------------------------------------------------------
    BoundingBox GetBox() const;

    //------------------------------------------------------------------------------
    //! @brief      三角形の交差判定を行います.
    //------------------------------------------------------------------------------
    bool IsHitTriangle( 
        const Ray&,
        const Vector3&,
        const Vector3&,
        const Vector3&,
        const Vector2&,
        const Vector2&,
        const Vector2&,
       HitRecord&
    ) const;
};

} // namespace s3d

#endif // __S3D_SHAPE_H__

