//-------------------------------------------------------------------------------------------------
// File : s3d_texturedmaterial.cpp
// Desc : Textured Material.
// Copyright(c) Project Asura. All right reserved.
//-------------------------------------------------------------------------------------------------

//-------------------------------------------------------------------------------------------------
// Includes
//-------------------------------------------------------------------------------------------------
#include <s3d_texturedmaterial.h>


namespace s3d {

///////////////////////////////////////////////////////////////////////////////////////////////////
// TexturedMaterial class
///////////////////////////////////////////////////////////////////////////////////////////////////

//-------------------------------------------------------------------------------------------------
//      コンストラクタです.
//-------------------------------------------------------------------------------------------------
TexturedMaterial::TexturedMaterial
(
    const Texture2D*        pTexture,
    const TextureSampler*   pSampler,
    IMaterial*              pMaterial
)
: m_Count       (1)
, m_pTexture    (pTexture)
, m_pSampler    (pSampler)
, m_pMaterial   (pMaterial)
{ m_pMaterial->AddRef(); }

//-------------------------------------------------------------------------------------------------
//      デストラクタです.
//-------------------------------------------------------------------------------------------------
TexturedMaterial::~TexturedMaterial()
{ SafeRelease(m_pMaterial); }

//-------------------------------------------------------------------------------------------------
//      参照カウントを増やします.
//-------------------------------------------------------------------------------------------------
void TexturedMaterial::AddRef()
{ m_Count++; }

//-------------------------------------------------------------------------------------------------
//      解放処理を行います.
//-------------------------------------------------------------------------------------------------
void TexturedMaterial::Release()
{
    m_Count--;
    if ( m_Count == 0 )
    { delete this; }
}

//-------------------------------------------------------------------------------------------------
//      参照カウントを取得します.
//-------------------------------------------------------------------------------------------------
u32 TexturedMaterial::GetCount() const
{ return m_Count; }

//-------------------------------------------------------------------------------------------------
//      シェーディングします.
//-------------------------------------------------------------------------------------------------
Color4 TexturedMaterial::Shade( ShadingArg& arg ) const
{
    return Color4::Mul(
        m_pMaterial->Shade( arg ),
        m_pTexture->Sample( *m_pSampler, arg.texcoord ) );
}

//-------------------------------------------------------------------------------------------------
//      エミッシブカラーを取得します.
//-------------------------------------------------------------------------------------------------
Color4 TexturedMaterial::GetEmissive() const
{ return m_pMaterial->GetEmissive(); }

//-------------------------------------------------------------------------------------------------
//      デルタ関数をもつかどうか?
//-------------------------------------------------------------------------------------------------
bool TexturedMaterial::HasDelta() const
{ return m_pMaterial->HasDelta(); }

Color4 TexturedMaterial::GetBaseColor(const Vector2& texcoord) const
{
    return Color4::Mul(
        m_pMaterial->GetBaseColor(texcoord),
        m_pTexture->Sample(*m_pSampler, texcoord));
}

//-------------------------------------------------------------------------------------------------
//      生成処理です.
//-------------------------------------------------------------------------------------------------
IMaterial* TexturedMaterial::Create
(
    const Texture2D*        pTexture,
    const TextureSampler*   pSampler,
    IMaterial*              pMaterial
)
{ return new(std::nothrow) TexturedMaterial(pTexture, pSampler, pMaterial); }

} // namespace s3d
